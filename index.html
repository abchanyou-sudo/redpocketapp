<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ç´…åŒ…å§“å + æ–°å°å¹£é‡‘é¡ OCR</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
:root{
  --bg:#0b0f19; --card:#12182a; --muted:#9fb0c3; --text:#eaf2ff; --accent:#7aa2ff;
  --ok:#62d39b; --warn:#ffbe5c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial; background:var(--bg); color:var(--text)}
header{position:sticky; top:0; z-index:10; backdrop-filter:blur(8px);
  background:linear-gradient(180deg, rgba(11,15,25,.9), rgba(11,15,25,.6) 70%, transparent);}
.wrap{max-width:960px; margin:0 auto; padding:16px}
h1{font-size:22px; margin:8px 0 2px}
p.sub{margin:0 0 8px; color:var(--muted); font-size:13px}
.grid{display:grid; gap:16px}
@media(min-width:860px){ .grid{grid-template-columns: 1.1fr .9fr} }
.card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
.card h2{font-size:16px; margin:4px 0 10px}
.hint{font-size:12px; color:var(--muted)}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.row > *{flex:1}
.button{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px; border-radius:12px;
  background:#24324d; color:var(--text); font-weight:600; border:1px solid rgba(255,255,255,.12); cursor:pointer; text-align:center}
.button.primary{background:var(--accent); color:#0b0f19; border:none}
.button.ghost{background:transparent}
.input-hidden{position:absolute; width:1px; height:1px; opacity:0; overflow:hidden; pointer-events:none}
.preview{display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px}
canvas,img{width:100%; max-height:320px; object-fit:contain; background:rgba(255,255,255,.03); border-radius:12px}
.kv{display:grid; grid-template-columns:110px 1fr; gap:8px; align-items:center; font-size:14px}
.pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#1b2540; color:var(--text); font-size:12px}
.pill.ok{background:#113524} .pill.warn{background:#3a2f11}
.progress{height:8px; width:100%; background:#1b253f; border-radius:999px; overflow:hidden}
.bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #9af); transition:width .2s}
table{width:100%; border-collapse:separate; border-spacing:0; margin-top:8px; font-size:14px}
thead th{position:sticky; top:0; background:#0f1526; z-index:1}
th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08)}
tbody tr:hover{background:rgba(255,255,255,.03)}
td[contenteditable="true"]{outline:none; border-radius:6px}
td[contenteditable="true"]:focus{box-shadow:0 0 0 2px var(--accent) inset}
.footer{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}
input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.02);color:var(--text)}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ç´…åŒ…å§“å + æ–°å°å¹£é‡‘é¡ OCR</h1>
    <p class="sub">ç”¨ç›¸æ©Ÿæˆ–ç›¸ç°¿ï¼Œè¾¨è­˜ç´…åŒ…<strong>åå­—</strong>èˆ‡<strong>éˆ”ç¥¨é‡‘é¡</strong>ï¼›å¯ç·¨è¼¯ã€ç·¨è™Ÿã€CSV åŒ¯å‡ºã€‚</p>
  </div>
</header>

<main class="wrap grid">
  <!-- â‘  ç´…åŒ…ï¼šå§“å -->
  <section class="card">
    <h2>â‘  ç´…åŒ…è¢‹ï¼šæŠ“åå­—</h2>
    <div class="row">
      <label class="button" for="nameCamera">ğŸ“· æ‹ç…§ï¼ˆç›¸æ©Ÿï¼‰</label>
      <label class="button" for="nameLibrary">ğŸ–¼ å¾ç›¸ç°¿é¸æ“‡</label>
      <button class="button primary" id="btnNameOcr">é‡æ–°è¾¨è­˜</button>
      <input id="nameCamera" class="input-hidden" type="file" accept="image/*" capture="environment">
      <input id="nameLibrary" class="input-hidden" type="file" accept="image/*">
    </div>
    <div class="preview" id="namePreview"></div>
    <div class="progress" aria-hidden="true"><div class="bar" id="nameProg"></div></div>
    <div class="kv" style="margin-top:8px">
      <div class="k">è¾¨è­˜çµæœ</div>
      <div><input id="nameText" type="text" placeholder="å¯æ‰‹å‹•ä¿®æ­£åå­—"></div>
      <div class="k">æç¤º</div>
      <div class="hint">ç›¡é‡ç›´æ‹å§“åå€ï¼›æ‰‹å¯«ä¸æ¸…å‰‡ç›´æ¥åœ¨ä¸Šé¢æ¬„ä½ä¿®æ­£ã€‚</div>
    </div>
  </section>

  <!-- â‘¡ éˆ”ç¥¨ï¼šé¢é¡åŠ ç¸½ -->
  <section class="card">
    <h2>â‘¡ éˆ”ç¥¨ï¼šæŠ“é¢é¡ä¸¦åŠ ç¸½</h2>
    <div class="row">
      <label class="button" for="cashCamera">ğŸ“· æ‹éˆ”ç¥¨ï¼ˆç›¸æ©Ÿï¼‰</label>
      <label class="button" for="cashLibrary">ğŸ–¼ å¾ç›¸ç°¿é¸æ“‡ï¼ˆå¯å¤šå¼µï¼‰</label>
      <button class="button primary" id="btnCashOcr">é‡æ–°è¾¨è­˜</button>
      <button class="button ghost" id="btnClearCash">æ¸…é™¤</button>
      <input id="cashCamera" class="input-hidden" type="file" accept="image/*" capture="environment">
      <input id="cashLibrary" class="input-hidden" type="file" accept="image/*" multiple>
    </div>
    <div class="preview" id="cashPreview"></div>
    <div class="progress" aria-hidden="true"><div class="bar" id="cashProg"></div></div>
    <div class="kv" style="margin-top:8px">
      <div class="k">è¾¨è­˜é¢é¡</div>
      <div id="denoList">å°šæœªè¾¨è­˜</div>
      <div class="k">ç¸½é‡‘é¡</div>
      <div><input id="totalAmount" type="number" inputmode="numeric" min="0" step="100" placeholder="0"></div>
    </div>
  </section>

  <!-- â‘¢ æ¸…å–® & åŒ¯å‡º -->
  <section class="card" style="grid-column:1/-1">
    <h2>â‘¢ æ–°å¢åˆ°æ¸…å–® & åŒ¯å‡º</h2>
    <div class="row">
      <button class="button primary" id="btnAdd">æ–°å¢åˆ°æ¸…å–®</button>
      <button class="button ghost" id="btnResetId">é‡ç½®ç·¨è™Ÿ</button>
      <span class="pill" id="saveBadge">æœªè®Šæ›´</span>
    </div>
    <table>
      <thead><tr><th style="width:90px">ç·¨è™Ÿ</th><th>åå­—</th><th style="width:160px">ç¸½é‡‘é¡</th><th style="width:60px">åˆªé™¤</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="footer">
      <button class="button" id="btnExport">ä¸‹è¼‰ CSV</button>
      <button class="button ghost" id="btnClearAll">æ¸…ç©ºæ¸…å–®</button>
    </div>
    <p class="hint">è³‡æ–™æœƒè‡ªå‹•æš«å­˜æ–¼ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚CSV æ¬„ä½ï¼šid, name, amountã€‚</p>
  </section>
</main>

<script>
// å°å·¥å…·
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
const state={ nextId:Number(localStorage.getItem('hb_nextId')||'1'), rows:JSON.parse(localStorage.getItem('hb_rows')||'[]'), selectedNameFile:null, selectedCashFiles:[] };
const saveState=()=>{ localStorage.setItem('hb_nextId',String(state.nextId)); localStorage.setItem('hb_rows',JSON.stringify(state.rows)); badge('å·²å„²å­˜','ok'); renderTable(); };
const badge=(t,k)=>{ const el=$('#saveBadge'); el.textContent=t; el.className='pill '+(k||''); setTimeout(()=>{el.textContent='æœªè®Šæ›´'; el.className='pill';},1400); };
const ensureTesseract=()=>{ if(!window.Tesseract){ alert('Tesseract.js æœªè¼‰å…¥'); return false;} return true; };
const renderPreviews=(files,container)=>{ container.innerHTML=''; [...files].forEach(f=>{ const url=URL.createObjectURL(f); const img=new Image(); img.src=url; img.loading='lazy'; container.appendChild(img); }); };

// å§“å OCRï¼ˆç¹ä¸­ï¼‰
const runNameOCR=async(file)=>{
  if(!ensureTesseract()||!file) return '';
  const bar=$('#nameProg'); bar.style.width='0%';
  const worker=await Tesseract.createWorker('chi_tra',1,{ logger:m=>{ if(m.status==='recognizing text'&&m.progress) bar.style.width=(m.progress*100).toFixed(0)+'%'; }});
  const {data:{text}}=await worker.recognize(file,{ tessedit_char_blacklist:'0123456789' });
  await worker.terminate();
  return (text||'').replace(/[\s\t\n]+/g,' ').replace(/(æ•¬è´ˆ|è³€|æ”¶|å•Ÿ|å…ˆç”Ÿ|å°å§|å¤«å©¦|å…„|å§|å¼Ÿ|å¦¹|å°ç«¯|éˆåº§|å…ˆç”Ÿå°å§)/g,'').trim();
};

// éˆ”ç¥¨ OCRï¼ˆå‡ç´šï¼šå‰è™•ç† + è‹±æ•¸ + ç¹ä¸­ + 0Â°/180Â°ï¼‰
const HB_MAP_ZH=[ {k:/è²³ä»Ÿ|è²®ä»Ÿ|è´°ä»Ÿ/g,v:2000},{k:/å£¹ä»Ÿ|ä¸€åƒ/g,v:1000},{k:/ä¼ä½°|äº”ç™¾/g,v:500},{k:/è²³ä½°|è²®ä½°|è´°ä½°|äºŒç™¾/g,v:200},{k:/å£¹ä½°|ä¸€ç™¾/g,v:100} ];
const hbPreprocess=(file,rot=false)=>new Promise(res=>{ const img=new Image(); img.onload=()=>{ const w=img.naturalWidth,h=img.naturalHeight; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); if(rot){ctx.translate(w,h);ctx.rotate(Math.PI);} ctx.drawImage(img,0,0); const d=ctx.getImageData(0,0,w,h); const px=d.data; for(let i=0;i<px.length;i+=4){ const g=0.299*px[i]+0.587*px[i+1]+0.114*px[i+2]; const v=Math.max(0,Math.min(255,(g-128)*1.25+128)); const bw=v>160?255:0; px[i]=px[i+1]=px[i+2]=bw; px[i+3]=255;} ctx.putImageData(d,0,0); res(c); }; img.src=URL.createObjectURL(file); });
const hbTextToDenoms=(t)=>{ const out=[]; if(!t) return out; const s=t.replace(/[Oã€‡ï¼¯]/g,'0').replace(/[Ilï¼‘â… ]/g,'1').replace(/[\s,\.ï¼Œ]+/g,''); ['2000','1000','500','200','100'].forEach(p=>{(s.match(new RegExp(p,'g'))||[]).forEach(()=>out.push(Number(p)));}); return out;};
const smartRunCashOCR=async(files)=>{
  if(!ensureTesseract()||!files?.length) return {list:[],total:0};
  const bar=$('#cashProg'); bar.style.width='0%';
  const wEng=await Tesseract.createWorker('eng',1,{logger:m=>{if(m.status==='recognizing text'&&m.progress) bar.style.width=(m.progress*100).toFixed(0)+'%';}});
  const wZh =await Tesseract.createWorker('chi_tra',1);
  const found=[];
  for(const f of files){
    const c0=await hbPreprocess(f,false), c1=await hbPreprocess(f,true);
    const r1=await wEng.recognize(c0,{tessedit_char_whitelist:'0123456789'});
    const r2=await wEng.recognize(c1,{tessedit_char_whitelist:'0123456789'});
    hbTextToDenoms(r1.data.text).forEach(v=>found.push(v));
    hbTextToDenoms(r2.data.text).forEach(v=>found.push(v));
    const rz0=await wZh.recognize(c0), rz1=await wZh.recognize(c1);
    const zh=(rz0.data.text+' '+rz1.data.text);
    HB_MAP_ZH.forEach(({k,v})=>{ ((zh.match(k))||[]).forEach(()=>found.push(v)); });
  }
  await wEng.terminate(); await wZh.terminate();
  const counts={2000:0,1000:0,500:0,200:0,100:0}; found.forEach(v=>{ if(counts[v]!=null) counts[v]++; });
  const list=Object.entries(counts).filter(([,c])=>c>0).map(([v,c])=>({value:Number(v),count:c}));
  const total=list.reduce((s,it)=>s+it.value*it.count,0);
  return {list,total};
};

// è¡¨æ ¼
const tbody=$('#tbody');
function renderTable(){
  tbody.innerHTML='';
  state.rows.forEach(({id,name,amount})=>{
    const tr=document.createElement('tr');
    const tdId=document.createElement('td'); tdId.textContent=id;
    const tdName=document.createElement('td'); tdName.textContent=name; tdName.contentEditable='true';
    const tdAmt=document.createElement('td'); tdAmt.textContent=amount; tdAmt.contentEditable='true'; tdAmt.inputMode='numeric';
    const tdDel=document.createElement('td'); const del=document.createElement('button'); del.className='button ghost'; del.textContent='åˆª'; del.style.padding='6px 10px';
    del.onclick=()=>{ state.rows=state.rows.filter(r=>r.id!==id); saveState(); };
    tdDel.appendChild(del); tr.append(tdId,tdName,tdAmt,tdDel);
    tdName.addEventListener('blur',()=>{ const r=state.rows.find(r=>r.id===id); r.name=tdName.textContent.trim(); saveState(); });
    tdAmt.addEventListener('blur',()=>{ const r=state.rows.find(r=>r.id===id); r.amount=Number(tdAmt.textContent.replace(/[^0-9]/g,''))||0; tdAmt.textContent=r.amount; saveState(); });
    tbody.appendChild(tr);
  });
}

// äº‹ä»¶ï¼šå§“åï¼ˆé¸å®Œè‡ªå‹•ï¼‰
const doNameOCR=async(f)=>{ if(!f) return; state.selectedNameFile=f; renderPreviews([f],$('#namePreview')); $('#nameText').value='è¾¨è­˜ä¸­â€¦'; $('#nameText').value=await runNameOCR(f)||''; };
$('#nameCamera').addEventListener('change',e=>doNameOCR(e.target.files?.[0]));
$('#nameLibrary').addEventListener('change',e=>doNameOCR(e.target.files?.[0]));
$('#btnNameOcr').addEventListener('click',()=> state.selectedNameFile?doNameOCR(state.selectedNameFile):alert('è«‹å…ˆé¸æ“‡ç´…åŒ…è¢‹ç…§ç‰‡'));

// äº‹ä»¶ï¼šéˆ”ç¥¨ï¼ˆé¸å®Œè‡ªå‹•ï¼‰
const doCashOCR=async(files)=>{ if(!files||!files.length) return; state.selectedCashFiles=Array.from(files); renderPreviews(state.selectedCashFiles,$('#cashPreview'));
  $('#denoList').textContent='è¾¨è­˜ä¸­â€¦'; const {list,total}=await smartRunCashOCR(state.selectedCashFiles);
  $('#denoList').innerHTML = list.length ? list.map(it=>`<span class="pill">$${it.value} Ã— ${it.count}</span>`).join(' ') : '<span class="pill warn">æœªåµæ¸¬åˆ°é¢é¡ï¼Œè«‹æ”¹ç›´æ‹é¢é¡è§’è½æˆ–æ‰‹å‹•è¼¸å…¥</span>';
  $('#totalAmount').value=String(total||0);
};
$('#cashCamera').addEventListener('change',e=>doCashOCR(e.target.files?[e.target.files[0]]:[]));
$('#cashLibrary').addEventListener('change',e=>doCashOCR(e.target.files||[]));
$('#btnCashOcr').addEventListener('click',()=> state.selectedCashFiles.length?doCashOCR(state.selectedCashFiles):alert('è«‹å…ˆé¸æ“‡éˆ”ç¥¨ç…§ç‰‡'));
$('#btnClearCash').addEventListener('click',()=>{ state.selectedCashFiles=[]; $('#cashPreview').innerHTML=''; $('#denoList').textContent='å°šæœªè¾¨è­˜'; $('#totalAmount').value=''; $('#cashProg').style.width='0%'; });

// æ–°å¢/åŒ¯å‡º
$('#btnAdd').addEventListener('click',()=>{ const name=$('#nameText').value.trim(); const amount=Number($('#totalAmount').value||'0');
  if(!name){ alert('è«‹å…ˆå¡«å¯«åå­—'); return; } state.rows.push({id:state.nextId++, name, amount:isFinite(amount)?amount:0}); saveState(); });
$('#btnResetId').addEventListener('click',()=>{ if(confirm('ç¢ºå®šå°‡ä¸‹æ¬¡æ–°å¢çš„ç·¨è™Ÿé‡ç½®ç‚º 1ï¼Ÿ')){ state.nextId=1; saveState(); }});
$('#btnClearAll').addEventListener('click',()=>{ if(confirm('é€™æœƒæ¸…ç©ºæ¸…å–®ï¼Œä¸”ç„¡æ³•é‚„åŸã€‚ç¢ºå®šï¼Ÿ')){ state.rows=[]; saveState(); }});
$('#btnExport').addEventListener('click',()=>{ const lines=[['id','name','amount'],...state.rows.map(r=>[r.id,r.name,r.amount])];
  const csv=lines.map(r=>r.map(v=>{const s=String(v??''); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(',')).join('\n');
  const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='redpack_records.csv'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1000);
});

// èµ·å§‹æ¸²æŸ“
renderTable();
</script>
</body>
</html>
