<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>紅包姓名 + 新台幣金額 OCR（iPhone 可用）</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root{
      --bg:#0b0f19; --card:#12182a; --muted:#9fb0c3; --text:#eaf2ff; --accent:#7aa2ff; --ok:#62d39b; --warn:#ffbe5c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:10; backdrop-filter:blur(8px); background:linear-gradient(180deg, rgba(11,15,25,.9), rgba(11,15,25,.6) 70%, transparent);}
    .wrap{max-width:980px; margin:0 auto; padding:16px}
    h1{font-size:22px; margin:8px 0 2px}
    p.sub{margin:0 0 8px; color:var(--muted); font-size:13px}
    .grid{display:grid; gap:16px}
    @media(min-width:820px){ .grid{grid-template-columns: 1.1fr .9fr} }
    .card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:16px; margin:4px 0 10px}
    .hint{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    input[type=file].filebtn{display:block; width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:#eaf2ff}
    .btn{appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:600; color:#0b0f19; background:var(--accent); cursor:pointer}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.15); color:var(--text)}
    .preview{display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px}
    canvas, img{width:100%; max-height:320px; object-fit:contain; background:rgba(255,255,255,.03); border-radius:12px}
    .kv{display:grid; grid-template-columns: 110px 1fr; gap:8px; align-items:center; font-size:14px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#1b2540; color:#eaf2ff; font-size:12px}
    .pill.ok{background:#113524}
    .pill.warn{background:#3a2f11}
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:8px; font-size:14px}
    thead th{position:sticky; top:0; background:#0f1526; z-index:1}
    th, td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08)}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    td[contenteditable="true"]{outline:none; border-radius:6px}
    td[contenteditable="true"]:focus{box-shadow:0 0 0 2px var(--accent) inset}
    .footer{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}
    .progress{height:8px; width:100%; background:#1b253f; border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #9af); transition:width .2s}
  </style>
  <!-- Tesseract.js CDN（需網路） -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>紅包姓名 + 新台幣金額 OCR</h1>
      <p class="sub">純前端、GitHub Pages 可用。iPhone 可直接用相機或相簿，辨識紅包<strong>名字</strong>與<strong>鈔票總金額</strong>，可編輯與匯出 CSV。</p>
    </div>
  </header>

  <main class="wrap grid">
    <!-- ① 紅包袋：姓名 -->
    <section class="card" id="sec-name">
      <h2>① 紅包袋：抓名字</h2>
      <div class="row">
        <input id="nameCamera" class="filebtn" type="file" accept="image/*" capture="environment" />
        <input id="nameLibrary" class="filebtn" type="file" accept="image/*" />
        <button class="btn" id="btnNameOcr">重新辨識</button>
      </div>
      <div class="preview" id="namePreview"></div>
      <div class="progress" aria-hidden="true"><div class="bar" id="nameProg"></div></div>
      <div style="margin-top:8px" class="kv">
        <div class="k">辨識結果</div>
        <div class="v"><input id="nameText" placeholder="可手動修正名字" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.02);color:#eaf2ff"/></div>
        <div class="k">提示</div>
        <div class="v hint">若手寫不清，直接改這個欄位即可。</div>
      </div>
    </section>

    <!-- ② 鈔票：面額加總 -->
    <section class="card" id="sec-cash">
      <h2>② 鈔票：抓面額並加總</h2>
      <div class="row">
        <input id="cashCamera" class="filebtn" type="file" accept="image/*" capture="environment" />
        <input id="cashLibrary" class="filebtn" type="file" accept="image/*" multiple />
        <button class="btn" id="btnCashOcr">重新辨識</button>
        <button class="btn ghost" id="btnClearCash">清除</button>
      </div>
      <div class="preview" id="cashPreview"></div>
      <div class="progress" aria-hidden="true"><div class="bar" id="cashProg"></div></div>
      <div class="kv" style="margin-top:8px">
        <div class="k">辨識面額</div>
        <div class="v" id="denoList">尚未辨識</div>
        <div class="k">總金額</div>
        <div class="v"><input id="totalAmount" type="number" inputmode="numeric" min="0" step="100" placeholder="0" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.02);color:#eaf2ff"/></div>
      </div>
    </section>

    <!-- ③ 清單 & 匯出 -->
    <section class="card" id="sec-list" style="grid-column:1/-1">
      <h2>③ 新增到清單 & 匯出</h2>
      <div class="row">
        <button class="btn" id="btnAdd">新增到清單</button>
        <button class="btn ghost" id="btnResetId">重置編號</button>
        <span class="pill" id="saveBadge">未變更</span>
      </div>
      <table>
        <thead>
          <tr><th style="width:90px">編號</th><th>名字</th><th style="width:160px">總金額</th><th style="width:60px">刪除</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="footer">
        <button class="btn" id="btnExport">下載 CSV</button>
        <button class="btn ghost" id="btnClearAll">清空清單</button>
      </div>
      <p class="hint">資料會自動暫存於瀏覽器（localStorage）。CSV 欄位順序：id, name, amount。</p>
    </section>
  </main>

  <script>
    // 工具
    const $  = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const state = {
      nextId: Number(localStorage.getItem('hb_nextId')||'1'),
      rows: JSON.parse(localStorage.getItem('hb_rows')||'[]'),
      selectedNameFile: null,
      selectedCashFiles: []
    };

    const saveState = () => {
      localStorage.setItem('hb_nextId', String(state.nextId));
      localStorage.setItem('hb_rows', JSON.stringify(state.rows));
      badge('已儲存', 'ok'); renderTable();
    };
    const badge = (text, kind) => {
      const el = $('#saveBadge'); el.textContent = text; el.className = 'pill ' + (kind||'');
      setTimeout(()=>{ el.textContent='未變更'; el.className='pill'; }, 1500);
    };
    const ensureTesseract = () => {
      if (!window.Tesseract) { alert('Tesseract.js 未載入'); return false; }
      return true;
    };
    const renderPreviews = (files, container) => {
      container.innerHTML = '';
      [...files].forEach(file => {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img'); img.src = url; img.loading='lazy';
        container.appendChild(img);
      });
    };

    // 姓名 OCR（繁中）
    const runNameOCR = async (file) => {
      if (!ensureTesseract() || !file) return '';
      const bar = $('#nameProg'); bar.style.width='0%';
      const worker = await Tesseract.createWorker('chi_tra', 1, {
        logger: m => { if (m.status==='recognizing text' && m.progress) bar.style.width = (m.progress*100).toFixed(0)+'%'; }
      });
      const { data: { text } } = await worker.recognize(file, { tessedit_char_blacklist: '0123456789' });
      await worker.terminate();
      return (text||'').replace(/[\s\t\n]+/g,' ').replace(/(敬贈|賀|收|啟|先生|小姐|夫婦|兄|姐|弟|妹|台端|鈞座|先生小姐)/g,'').trim();
    };

    // 鈔票 OCR（英數，抓 100/200/500/1000/2000）
    const runCashOCR = async (files) => {
      if (!ensureTesseract() || !files?.length) return { list:[], total:0 };
      const bar = $('#cashProg'); bar.style.width='0%';
      const worker = await Tesseract.createWorker('eng', 1, {
        logger: m => { if (m.status==='recognizing text' && m.progress) bar.style.width = (m.progress*100).toFixed(0)+'%'; }
      });
      const found = [];
      for (const f of files) {
        const { data: { text } } = await worker.recognize(f, { tessedit_char_whitelist:'0123456789' });
        const norm = (text||'').replace(/[O〇Ｏ]/g,'0').replace(/[Il１Ⅰ]/g,'1');
        (norm.match(/\b(2000|1000|500|200|100)\b/g) || []).forEach(t=>found.push(Number(t)));
      }
      await worker.terminate();
      const counts = {2000:0,1000:0,500:0,200:0,100:0};
      found.forEach(v=>{ if (counts[v]!=null) counts[v]++; });
      const list = Object.entries(counts).filter(([,c])=>c>0).map(([v,c])=>({value:Number(v), count:c}));
      const total = list.reduce((s,it)=> s + it.value*it.count , 0);
      return { list, total };
    };

    // 表格
    const tbody = $('#tbody');
    const renderTable = () => {
      tbody.innerHTML = '';
      state.rows.forEach(({id,name,amount})=>{
        const tr = document.createElement('tr');
        const tdId = document.createElement('td'); tdId.textContent = id;
        const tdName = document.createElement('td'); tdName.textContent = name; tdName.contentEditable = 'true';
        const tdAmt = document.createElement('td'); tdAmt.textContent = amount; tdAmt.contentEditable = 'true'; tdAmt.inputMode='numeric';
        const tdDel = document.createElement('td');
        const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='刪'; delBtn.style.padding='6px 10px';
        delBtn.onclick=()=>{ state.rows = state.rows.filter(r=>r.id!==id); saveState(); };
        tdDel.appendChild(delBtn);
        tr.append(tdId, tdName, tdAmt, tdDel);
        tdName.addEventListener('blur', ()=>{ const r = state.rows.find(r=>r.id===id); r.name = tdName.textContent.trim(); saveState(); });
        tdAmt.addEventListener('blur', ()=>{ const r = state.rows.find(r=>r.id===id); r.amount = Number(tdAmt.textContent.replace(/[^0-9]/g,''))||0; tdAmt.textContent=r.amount; saveState(); });
        tbody.appendChild(tr);
      });
    };

    // 事件：姓名（選完自動 OCR）
    const doNameOCR = async (f) => {
      if (!f) return; state.selectedNameFile = f; renderPreviews([f], $('#namePreview'));
      $('#nameText').value = '辨識中…'; const t = await runNameOCR(f); $('#nameText').value = t || '';
    };
    $('#nameCamera').addEventListener('change', e=> doNameOCR(e.target.files?.[0]));
    $('#nameLibrary').addEventListener('change', e=> doNameOCR(e.target.files?.[0]));
    $('#btnNameOcr').addEventListener('click', ()=> state.selectedNameFile ? doNameOCR(state.selectedNameFile) : alert('請先選擇紅包袋照片'));

    // 事件：鈔票（選完自動 OCR）
    const doCashOCR = async (files) => {
      if (!files || !files.length) return; state.selectedCashFiles = Array.from(files);
      renderPreviews(state.selectedCashFiles, $('#cashPreview'));
      $('#denoList').textContent = '辨識中…';
      const { list, total } = await runCashOCR(state.selectedCashFiles);
      $('#denoList').innerHTML = list.length ? list.map(it=>`<span class="pill">$${it.value} × ${it.count}</span>`).join(' ')
                                             : '<span class="pill warn">未偵測到面額，可手動輸入總金額</span>';
      $('#totalAmount').value = String(total||0);
    };
    $('#cashCamera').addEventListener('change', e=> doCashOCR(e.target.files ? [e.target.files[0]] : []));
    $('#cashLibrary').addEventListener('change', e=> doCashOCR(e.target.files || []));
    $('#btnCashOcr').addEventListener('click', ()=> state.selectedCashFiles.length ? doCashOCR(state.selectedCashFiles) : alert('請先選擇鈔票照片'));
    $('#btnClearCash').addEventListener('click', ()=>{
      state.selectedCashFiles = []; $('#cashPreview').innerHTML = ''; $('#denoList').textContent = '尚未辨識';
      $('#totalAmount').value = ''; $('#cashProg').style.width='0%';
    });

    // 新增/編號/匯出
    $('#btnAdd').addEventListener('click', ()=>{
      const name = $('#nameText').value.trim();
      const amount = Number($('#totalAmount').value||'0');
      if (!name) { alert('請先填寫名字（可手動輸入）'); return; }
      state.rows.push({ id: state.nextId++, name, amount: isFinite(amount)? amount: 0 });
      saveState();
    });
    $('#btnResetId').addEventListener('click', ()=>{ if(confirm('確定將下次新增的編號重置為 1？')) { state.nextId = 1; saveState(); } });
    $('#btnClearAll').addEventListener('click', ()=>{ if(confirm('這會清空清單，且無法還原。確定？')) { state.rows = []; saveState(); } });
    $('#btnExport').addEventListener('click', ()=>{
      const lines = [ ['id','name','amount'], ...state.rows.map(r=>[r.id, r.name, r.amount]) ];
      const csv = lines.map(r=> r.map(v=>{
        const s = String(v??''); return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'redpack_records.csv';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });

    // 起始渲染
    renderTable();
  </script>
</body>
</html>
